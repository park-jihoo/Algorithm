name: CI Pipeline

on:
  pull_request:
  push:
    branches:
      - main

jobs:
  format_and_update_readme:
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      - name: Checkout
        uses: actions/checkout@v3
        with:
          fetch-depth: 0  # 전체 git 기록을 가져옴

      # 코드 포맷팅 단계
      - name: Prettify Code
        uses: creyD/prettier_action@v4.3

      - name: Google Java Format
        uses: axel-op/googlejavaformat-action@v3.6.0

      - name: Run Black Formatter
        uses: psf/black@stable
        with:
          jupyter: true

      - name: Reformat SQL Files
        uses: credfeto/action-sql-format@v1.4.1

      - name: Clang-format Lint (C)
        uses: DoozyX/clang-format-lint-action@v0.16.2
        with:
          inplace: true

      # README.md 생성 단계
      - name: Generate README.md
        run: |
          echo "# Algorithms Archive" > README.md
          echo "" >> README.md
          echo "This project contains the following subfolders (up to 3 levels deep):" >> README.md
          echo "" >> README.md
          echo "| Platform   | Difficulty | Problem Name |" >> README.md
          echo "|------------|------------|--------------|" >> README.md

          find . -type d -not -path './.*' -mindepth 3 -maxdepth 3 | while read -r folder; do
            folder_path=${folder#./}
            platform=$(echo "$folder_path" | cut -d'/' -f1)
            difficulty=$(echo "$folder_path" | cut -d'/' -f2)
            problem_name=$(basename "$folder")
            echo "| ${platform} | ${difficulty} | [${problem_name}](./${folder_path}/)|" >> README.md
          done

          echo "" >> README.md
          echo "Click on the problem names to view their contents." >> README.md

      # 모든 변경 사항 커밋 및 푸시
      - name: Commit and Push Changes
        run: |
          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"
          git add .
          git commit -m "Code formatting and README update"
          git push
